syntax = "proto3";

package duckops.scan.v1;

option go_package = "duckops-shared/proto/gen/scanv1";

// ─────────────────────────────────────────────────────
// Scan Service — used between Agent ↔ Orchestrator
// ─────────────────────────────────────────────────────

service ScanService {
  // SubmitScan sends a scan request from the agent to the server
  rpc SubmitScan(SubmitScanRequest) returns (SubmitScanResponse);

  // GetScanStatus checks the status of an ongoing scan
  rpc GetScanStatus(GetScanStatusRequest) returns (GetScanStatusResponse);

  // StreamScanResults streams results back to the agent as they arrive
  rpc StreamScanResults(StreamScanResultsRequest) returns (stream ScanResultEvent);
}

// ─────────────────────────────────────────────────────
// Messages
// ─────────────────────────────────────────────────────

message SubmitScanRequest {
  string target = 1;           // repo URL, image name, file path
  string scanner_type = 2;     // SAST, DAST, SECRETS, CONTAINER, DEPENDENCY, IAC
  int32 priority = 3;
  map<string, string> metadata = 4; // branch, commit, env, etc.
}

message SubmitScanResponse {
  string scan_id = 1;
  string status = 2;          // PENDING
}

message GetScanStatusRequest {
  string scan_id = 1;
}

message GetScanStatusResponse {
  string scan_id = 1;
  string status = 2;          // PENDING, RUNNING, COMPLETED, FAILED
  ScanSummary summary = 3;
  string error = 4;
}

message StreamScanResultsRequest {
  string scan_id = 1;
}

message ScanResultEvent {
  string scan_id = 1;
  string event_type = 2;      // VULNERABILITY_FOUND, LOG, STATUS_CHANGE, COMPLETE
  Vulnerability vulnerability = 3;
  string log_line = 4;
  string new_status = 5;
}

// ─────────────────────────────────────────────────────
// Shared Types
// ─────────────────────────────────────────────────────

message Vulnerability {
  string id = 1;
  string title = 2;
  string description = 3;
  string severity = 4;        // CRITICAL, HIGH, MEDIUM, LOW, INFO
  string location = 5;
  int32 line = 6;
  string cve = 7;
  double cvss = 8;
  string remediation = 9;
  repeated string references = 10;
}

message ScanSummary {
  int32 total = 1;
  int32 critical = 2;
  int32 high = 3;
  int32 medium = 4;
  int32 low = 5;
  int32 info = 6;
}
